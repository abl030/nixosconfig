version: "3.8"

services:
  autoheal:
    container_name: autoheal
    image: docker.io/willfarrell/autoheal:latest
    restart: unless-stopped
    environment:
      - TZ=Australia/Perth
      # Optional: Define the label autoheal looks for.
      # 'all' or leaving it unset defaults to monitoring containers with label `autoheal=true`.
      - AUTOHEAL_CONTAINER_LABEL=all
      # Optional: Set loop interval (default 5 seconds)
      - AUTOHEAL_INTERVAL=30
      # Optional: Stop timeout before sending SIGKILL (default 10 seconds)
      - AUTOHEAL_STOP_TIMEOUT=10
    volumes:
      # REQUIRED: Mount the docker socket so autoheal can interact with docker daemon
      - ${XDG_RUNTIME_DIR}/podman/podman.sock:/var/run/docker.sock

  dozzle-agent:
    image: docker.io/amir20/dozzle:latest
    container_name: dozzle-agent
    restart: unless-stopped
    # This is the crucial part that runs Dozzle in agent mode
    command: agent
    environment:
      # This gives your remote host a friendly name in the Dozzle UI
      - DOZZLE_HOSTNAME=epimetheus
    ports:
      # Exposes the agent on port 7007. Ensure this port is not in use.
      - "7007:7007"
    volumes:
      # Mount the Docker socket (read-only is best practice for agents)
      - ${XDG_RUNTIME_DIR}/podman/podman.sock:/var/run/docker.sock:ro
    healthcheck:
      test: ["CMD", "/dozzle", "healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
