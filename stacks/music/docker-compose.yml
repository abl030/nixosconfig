version: "3.8"

services:
  # ---------------------------------------------------------------
  # Network Holder
  # ---------------------------------------------------------------
  music-network-holder:
    image: registry.k8s.io/pause:3.9
    container_name: music_network_holder
    ports:
      - "8686:8686" # Lidarr
      # - "3579:3579" # Ombi - disabled, crash-looping
      - "8085:8085" # Filebrowser
      - "5030:5030" # slskd Web UI
      - "5031:5031" # slskd API
    restart: unless-stopped
    dns:
      - 1.1.1.1
      - 8.8.8.8
    networks:
      - music-net

  # ---------------------------------------------------------------
  # Lidarr
  # ---------------------------------------------------------------
  lidarr:
    image: lscr.io/linuxserver/lidarr:latest
    container_name: lidarr
    environment:
      # Rootless podman: PUID=0 maps to host user
      - PUID=0
      - PGID=0
      - TZ=Australia/Perth
    volumes:
      - ${DATA_ROOT}/music/lidarr:/config
      - ${MEDIA_ROOT:-/mnt/data}/Media/Temp/slskd:/downloads
      - ${MEDIA_ROOT:-/mnt/data}/Media/Music/AI:/music
    network_mode: "service:music-network-holder"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "timeout 10s stat /music && stat /downloads && curl -f http://localhost:8686/ping || exit 1"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 60s
    labels:
      - autoheal=true
    depends_on:
      - music-network-holder

  # ---------------------------------------------------------------
  # slskd - Soulseek client with REST API
  # ---------------------------------------------------------------
  slskd:
    image: docker.io/slskd/slskd:latest
    container_name: slskd
    labels:
      - io.containers.autoupdate=registry
      - autoheal=true
    environment:
      - SLSKD_REMOTE_CONFIGURATION=true
      - SLSKD_SLSK_USERNAME=${SOULSEEK_USERNAME}
      - SLSKD_SLSK_PASSWORD=${SOULSEEK_PASSWORD}
      - SLSKD_DOWNLOADS_DIR=/downloads
      - SLSKD_INCOMPLETE_DIR=/downloads/incomplete
      - SLSKD_SHARED_DIR=/music
      - TZ=Australia/Perth
    volumes:
      - ${DATA_ROOT}/music/slskd:/app
      - ${MEDIA_ROOT:-/mnt/data}/Media/Temp/slskd:/downloads
      - ${MEDIA_ROOT:-/mnt/data}/Media/Music/AI:/music:ro
    network_mode: "service:music-network-holder"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:5030/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    depends_on:
      - music-network-holder

  # ---------------------------------------------------------------
  # Soularr - Lidarr to slskd bridge
  # ---------------------------------------------------------------
  soularr:
    image: docker.io/mrusse08/soularr:latest
    container_name: soularr
    labels:
      - io.containers.autoupdate=registry
    environment:
      - TZ=Australia/Perth
      - SCRIPT_INTERVAL=300
    volumes:
      - ${DATA_ROOT}/music/soularr:/data
      - ${MEDIA_ROOT:-/mnt/data}/Media/Temp/slskd:/downloads
    network_mode: "service:music-network-holder"
    restart: unless-stopped
    depends_on:
      slskd:
        condition: service_healthy
      lidarr:
        condition: service_healthy

  # ---------------------------------------------------------------
  # Ombi — disabled, crash-looping with coredumps
  # ---------------------------------------------------------------
  # Root cause: preStart envsubst generated database.json with empty
  # credentials when sops secrets weren't available yet. Ombi has no
  # env var support for DB creds — it requires database.json. Fix:
  # pass creds as env vars and generate database.json inside the
  # container via entrypoint command, eliminating the preStart race.
  #
  # NOT TESTED — left here for reference if Ombi is re-enabled.
  # ---------------------------------------------------------------
  # ombi:
  #   image: lscr.io/linuxserver/ombi:latest
  #   labels:
  #     - io.containers.autoupdate=registry
  #   container_name: ombi
  #   environment:
  #     - PUID=0
  #     - PGID=0
  #     - TZ=Australia/Perth
  #     - OMBI_DB_USER=${OMBI_DB_USER}
  #     - OMBI_DB_PASSWORD=${OMBI_DB_PASSWORD}
  #   # Generate database.json at container start from env vars.
  #   # This avoids the preStart race condition where sops secrets
  #   # weren't decrypted yet, resulting in empty credentials.
  #   entrypoint: /bin/bash
  #   command:
  #     - -c
  #     - |
  #       cat > /config/database.json <<DBEOF
  #       {
  #         "OmbiDatabase": {
  #           "Type": "MySQL",
  #           "ConnectionString": "Server=127.0.0.1;Port=3306;Database=Ombi;User=$${OMBI_DB_USER};Password=$${OMBI_DB_PASSWORD}"
  #         },
  #         "SettingsDatabase": {
  #           "Type": "MySQL",
  #           "ConnectionString": "Server=127.0.0.1;Port=3306;Database=Ombi_Settings;User=$${OMBI_DB_USER};Password=$${OMBI_DB_PASSWORD}"
  #         },
  #         "ExternalDatabase": {
  #           "Type": "MySQL",
  #           "ConnectionString": "Server=127.0.0.1;Port=3306;Database=Ombi_External;User=$${OMBI_DB_USER};Password=$${OMBI_DB_PASSWORD}"
  #         }
  #       }
  #       DBEOF
  #       exec /init
  #   volumes:
  #     - ${DATA_ROOT}/ombi/config:/config
  #   network_mode: "service:music-network-holder"
  #   restart: unless-stopped
  #   depends_on:
  #     ombi-db:
  #       condition: service_healthy
  #     music-network-holder:
  #       condition: service_started

  # ombi-db:
  #   image: docker.io/library/mariadb:10.11
  #   labels:
  #     - io.containers.autoupdate=registry
  #   container_name: ombi-db
  #   restart: unless-stopped
  #   environment:
  #     MYSQL_ROOT_PASSWORD: ${OMBI_DB_ROOT_PASSWORD}
  #     MYSQL_USER: ${OMBI_DB_USER}
  #     MYSQL_PASSWORD: ${OMBI_DB_PASSWORD}
  #   volumes:
  #     - ${DATA_ROOT}/ombi/db:/var/lib/mysql:U
  #     - ${INIT_SQL}:/docker-entrypoint-initdb.d/init.sql:ro
  #   network_mode: "service:music-network-holder"
  #   healthcheck:
  #     test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #     start_period: 30s
  #   depends_on:
  #     - music-network-holder

  # ---------------------------------------------------------------
  # Filebrowser
  # ---------------------------------------------------------------
  filebrowser:
    image: docker.io/filebrowser/filebrowser:v2
    labels:
      - autoheal=true
    container_name: music-filebrowser
    # Rootless podman: user 0:0 maps to host user
    user: "0:0"
    network_mode: "service:music-network-holder"
    environment:
      - FB_DATABASE=/config/filebrowser.db
      - FB_ROOT=/srv
      - FB_LOG=stdout
      - FB_PORT=8085
      - FB_ADDRESS=0.0.0.0
    volumes:
      # Mount the folder created by Nix (owned by 99:100) to /config
      - ${DATA_ROOT}/music/filebrowser:/config
      # Mount music as Read-Only
      - ${FUSE_ROOT:-/mnt/fuse}/Media/Music_RW:/srv:ro
      # Fix for timezone if needed
      - /etc/localtime:/etc/localtime:ro
    healthcheck:
      test: ["CMD-SHELL", "timeout 10s stat /srv || exit 1"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    depends_on:
      - music-network-holder

  # ---------------------------------------------------------------
  # Tailscale Sidecar
  # ---------------------------------------------------------------
  tailscale:
    image: docker.io/tailscale/tailscale:latest
    container_name: music-tailscale-sidecar
    network_mode: "service:music-network-holder"
    volumes:
      - ${DATA_ROOT}/tailscale/music:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun
      - /etc/localtime:/etc/localtime:ro
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      - TS_HOSTNAME=music
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=true
      - TS_ACCEPT_DNS=false
    restart: unless-stopped
    depends_on:
      - music-network-holder

  # ---------------------------------------------------------------
  # Caddy Reverse Proxy
  # ---------------------------------------------------------------
  caddy:
    image: ghcr.io/caddybuilds/caddy-cloudflare:latest
    container_name: music-caddy
    network_mode: "service:music-network-holder"
    environment:
      - CLOUDFLARE_API_TOKEN=${CLOUDFLARE_DNS_API_TOKEN}
    volumes:
      - ${CADDY_FILE}:/etc/caddy/Caddyfile:ro
      - ${DATA_ROOT}/music/caddy/data:/data
      - ${DATA_ROOT}/music/caddy/config:/config
      - /etc/localtime:/etc/localtime:ro
    restart: unless-stopped
    depends_on:
      - music-network-holder

networks:
  music-net:
    driver: bridge
