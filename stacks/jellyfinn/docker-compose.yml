version: "3.8"

services:
  # ---------------------------------------------------------------
  # Network holder for the core Jellyfin services
  # ---------------------------------------------------------------
  jellyfin-network-holder:
    image: registry.k8s.io/pause:3.9
    labels:
      - io.containers.autoupdate=registry
    container_name: jellyfin_network_holder
    ports:
      - "8096:8096" # Jellyfin HTTP
      - "8920:8920" # Jellyfin HTTPS (optional)
      - "7359:7359/udp" # Discovery (optional)
      - "1900:1900/udp" # DLNA (optional)
      - "3468:3468" # Autoscan
      - "8080:8080" # Watchstate WebUI
      # NOTE: Port 3000 for Jellystat has been moved
    restart: unless-stopped
    networks:
      - jellyfin-net

  jellyfin:
    image: lscr.io/linuxserver/jellyfin:latest
    container_name: jellyfin
    environment:
      - PUID=0
      - PGID=0
      - UMASK=002
      - TZ=Australia/Perth
      - JELLYFIN_PublishedServerUrl=192.168.1.33
    volumes:
      - ${DATA_ROOT}/jellyfin/jellyfin:/config
      - "${FUSE_ROOT:-/mnt/fuse}/Media/TV_Shows:/data/tvshows"
      - "${FUSE_ROOT:-/mnt/fuse}/Media/Movies:/data/movies"
      - "${FUSE_ROOT:-/mnt/fuse}/Media/Music:/data/music"
    devices:
      - /dev/dri:/dev/dri
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 4G
    healthcheck:
      test: ["CMD-SHELL", "timeout 10s stat /data/tvshows && stat /data/movies && stat /data/music || exit 1"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 60s
    labels:
      - io.containers.autoupdate=registry
      - autoheal=true
    network_mode: "service:jellyfin-network-holder"
    depends_on:
      - jellyfin-network-holder

  tailscale:
    image: docker.io/tailscale/tailscale:latest
    labels:
      - io.containers.autoupdate=registry
    container_name: jellyfin-tailscale-sidecar
    network_mode: "service:jellyfin-network-holder"
    volumes:
      - ${DATA_ROOT}/jellyfin/tailscale:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      - TS_HOSTNAME=jellyfin
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=false
      - TS_ACCEPT_DNS=false
    restart: unless-stopped
    depends_on:
      - jellyfin-network-holder

  caddy:
    image: ghcr.io/caddybuilds/caddy-cloudflare:latest
    labels:
      - io.containers.autoupdate=registry
    container_name: jellyfin-caddy
    network_mode: "service:jellyfin-network-holder"
    environment:
      - CLOUDFLARE_API_TOKEN=${CLOUDFLARE_API_TOKEN}
    volumes:
      # ─── UPDATED ───
      - ${CADDY_FILE}:/etc/caddy/Caddyfile:ro
      # ───────────────
      - ${DATA_ROOT}/jellyfin/caddy/data:/data
      - ${DATA_ROOT}/jellyfin/caddy/config:/config
      - /etc/localtime:/etc/localtime:ro
    restart: unless-stopped
    depends_on:
      - jellyfin-network-holder

  # autoscan:
    labels:
      - io.containers.autoupdate=registry
  #   image: ghcr.io/niniyas/autoscan:latest
    labels:
      - io.containers.autoupdate=registry
  #   container_name: jellyfin-autoscan
    labels:
      - io.containers.autoupdate=registry
  #   network_mode: "service:jellyfin-network-holder"
    labels:
      - io.containers.autoupdate=registry
  #   volumes:
    labels:
      - io.containers.autoupdate=registry
  #     - ${DATA_ROOT}/jellyfin/autoscan:/config
    labels:
      - io.containers.autoupdate=registry
  #     - ${XDG_RUNTIME_DIR}/podman/podman.sock:/var/run/docker.sock
    labels:
      - io.containers.autoupdate=registry
  #   environment:
    labels:
      - io.containers.autoupdate=registry
  #     - PUID=99
  #     - PGID=100
  #     - UMASK=0000
  #     - TZ=Australia/Perth
  #   restart: unless-stopped
    labels:
      - io.containers.autoupdate=registry
  #   depends_on:
    labels:
      - io.containers.autoupdate=registry
  #     - jellyfin-network-holder

  watchstate:
    image: ghcr.io/arabcoders/watchstate:latest
    labels:
      - io.containers.autoupdate=registry
    container_name: watchstate
    user: "0:0"
    network_mode: "service:jellyfin-network-holder"
    environment:
      - TZ=Australia/Perth
    volumes:
      - ${DATA_ROOT}/jellyfin/watchstate:/config
    restart: unless-stopped
    depends_on:
      - jellyfin-network-holder

  # ---------------------------------------------------------------
  # Jellystat Services
  # ---------------------------------------------------------------
  jellystat-db:
    image: docker.io/library/postgres:15.2
    labels:
      - io.containers.autoupdate=registry
    container_name: jellystat-db
    user: "0:0"
    restart: unless-stopped
    environment:
      - POSTGRES_USER=jellystat
      - POSTGRES_PASSWORD=${JELLYSTAT_DB_PASSWORD}
    volumes:
      - "${DATA_ROOT}/jellyfin/jellystat/postgres-data:/var/lib/postgresql/data"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U jellystat"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - jellyfin-net

  jellystat:
    image: docker.io/cyfershepard/jellystat:latest
    labels:
      - io.containers.autoupdate=registry
    container_name: jellystat
    user: "0:0"
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - POSTGRES_USER=jellystat
      - POSTGRES_PASSWORD=${JELLYSTAT_DB_PASSWORD}
      - POSTGRES_IP=jellystat-db
      - POSTGRES_PORT=5432
      - JELLYFIN_URL=http://jellyfin:8096
      - JWT_SECRET=${JELLYSTAT_JWT_SECRET}
      - TZ=Australia/Perth
    volumes:
      - "${DATA_ROOT}/jellyfin/jellystat/backup-data:/app/backend/backup-data"
    depends_on:
      jellystat-db:
        condition: service_healthy
    networks:
      - jellyfin-net

  # ---------------------------------------------------------------
  # inotify receiver (socat + tiny handler script) with startup logs + healthcheck
  # ---------------------------------------------------------------
  inotify-receiver:
    image: docker.io/alpine/socat:latest
    labels:
      - io.containers.autoupdate=registry
    container_name: inotify-receiver
    group_add:
      - "100" # users group for write access on /data/music/New
    userns_mode: "keep-id" # map host uid/gid so group 100 is real
    ports:
      - "9999:9999/udp"
    restart: unless-stopped
    volumes:
      - "${FUSE_ROOT:-/mnt/fuse}/Media/TV_Shows:/data/tv:rw"
      - "${FUSE_ROOT:-/mnt/fuse}/Media/Movies:/data/movies:rw"
      - "${FUSE_ROOT:-/mnt/fuse}/Media/Music:/data/music:rw"
      # ─── UPDATED ───
      - "${INOTIFY_SCRIPT}:/usr/local/bin/inotify-recv.sh:ro" # Ensure quotes and curly braces
      - "${INOTIFY_ENTRYPOINT}:/usr/local/bin/inotify-entrypoint.sh:ro"
      # ───────────────
    environment:
      - HEALTH_INTERVAL=30
      - HEALTH_WINDOW=180
      - HEALTH_FILE=/tmp/receiver-healthy
      # You can override these to match custom mounts; these are the defaults used by inotify-recv.sh
      - ROOT_MOVIES=/data/movies
      - ROOT_TV=/data/tv
      - ROOT_MUSIC=/data/music
    entrypoint: ["/usr/local/bin/inotify-entrypoint.sh"]
    healthcheck:
      test: >
        sh -lc '
          pidof socat >/dev/null 2>&1 &&
          now=$(date +%s) &&
          h=$(cat "$${HEALTH_FILE:-/tmp/receiver-healthy}" 2>/dev/null || echo 0) &&
          [ $((now - h)) -lt $${HEALTH_WINDOW:-180} ]'
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    security_opt: ["no-new-privileges:true"]
    tmpfs: ["/tmp", "/run"]
    depends_on:
      - jellyfin-network-holder

# Define the custom network used by the services
networks:
  jellyfin-net:
    driver: bridge
