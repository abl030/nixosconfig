version: "3.9"
services:
  inotify-sender:
    image: docker.io/devodev/inotify:0.3.0
    container_name: inotify-sender
    restart: unless-stopped

    # Run our script (mounted below)
    command: ["/bin/bash", "/sender.sh"]

    environment:
      TZ: Australia/Perth
      # Watch multiple roots (container paths)
      WATCH_DIRS: "/watch/movies,/watch/tv,/watch/music"
      # List all receivers (host or host:port), comma-separated
      REMOTE_HOSTS: "192.168.1.33"
      REMOTE_PORT: "9999"
      SRC_PREFIX: "/watch"
      DST_PREFIX: "/data"
      DEBOUNCE_SECS: "5"

    volumes:
      # map your Unraid paths read-only
      - ${UNRAID_ROOT:-/mnt/user}/data/Media/Movies:/watch/movies:ro
      - "${UNRAID_ROOT:-/mnt/user}/data/Media/TV Shows:/watch/tv:ro"
      - ${UNRAID_ROOT:-/mnt/user}/data/Media/Music:/watch/music:ro
      # mount the script
      - ${UNRAID_ROOT:-/mnt/user}/appdata/inotify-bridge/sender.sh:/sender.sh:ro
      # Map timezone from host
      - /etc/localtime:/etc/localtime:ro
      - ${TIMEZONE_FILE:-/etc/timezone}:/etc/timezone:ro

    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /run

    # Let autoheal watch this service
    labels:
      - io.containers.autoupdate=registry
      - autoheal=true

    # Healthcheck: OK when inotifywait is running and the flusher heartbeat updated recently.
    # Use a 180s window to avoid flapping on very idle libraries.
    healthcheck:
      test: >
        bash -lc '
          pgrep inotifywait >/dev/null &&
          now=$(date +%s) &&
          h=$(cat /tmp/sender-healthy 2>/dev/null || echo 0) &&
          [ $((now - h)) -lt 180 ]'
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Autoheal sidecar: restarts any container with label autoheal=true when unhealthy
  autoheal:
    image: docker.io/willfarrell/autoheal:latest
    labels:
      - io.containers.autoupdate=registry
    container_name: autoheal
    restart: unless-stopped
    environment:
      - TZ=Australia/Perth
      - AUTOHEAL_CONTAINER_LABEL=autoheal
      - AUTOHEAL_INTERVAL=30
      - AUTOHEAL_START_PERIOD=120
    volumes:
      - ${XDG_RUNTIME_DIR}/podman/podman.sock:/var/run/docker.sock:ro
      # Map timezone from host
      - /etc/localtime:/etc/localtime:ro
      - ${TIMEZONE_FILE:-/etc/timezone}:/etc/timezone:ro
    security_opt:
      - no-new-privileges:true
    read_only: true
