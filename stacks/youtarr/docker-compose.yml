version: "3.8"

services:
  youtarr:
    image: docker.io/dialmaster/youtarr:latest
    labels:
      - autoheal=true
    container_name: youtarr
    restart: unless-stopped
    ports:
      # Host Port : Container Port (3011 is hardcoded in the app)
      - "3087:3011"
    environment:
      - TZ=Australia/Perth
      # Rootless podman: UID=0 maps to host user
      - YOUTARR_UID=0
      - YOUTARR_GID=0
      # Internal path configuration (Must match the volume mount target)
      - YOUTUBE_OUTPUT_DIR=/usr/src/app/data
      # Database Connection (Variables populated via SOPS .env)
      - DB_HOST=youtarr-db
      - DB_PORT=3306
      - DB_NAME=youtarr
      - DB_USER=youtarr
      - DB_PASSWORD=youtarr
      - AUTH_ENABLED=false

    volumes:
      # Video Storage (Host Path -> Container Path)
      - ${MEDIA_ROOT:-/mnt/data}/Media/YouTube:/usr/src/app/data
      # App Data
      - ${DATA_ROOT}/youtarr/config:/app/config
      - ${DATA_ROOT}/youtarr/images:/app/server/images
      - ${DATA_ROOT}/youtarr/jobs:/app/jobs
    healthcheck:
      test: ["CMD-SHELL", "timeout 10s stat /usr/src/app/data || exit 1"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 60s
    depends_on:
      - youtarr-db

  youtarr-db:
    image: docker.io/library/mariadb:10.3
    container_name: youtarr-db
    restart: unless-stopped
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci --tc-heuristic-recover=rollback
    environment:
      - MYSQL_DATABASE=youtarr
      - MYSQL_USER=youtarr
      - MYSQL_PASSWORD=youtarr
      - MYSQL_ROOT_PASSWORD=youtarr
    volumes:
      - ${DATA_ROOT}/youtarr/database:/var/lib/mysql:U
