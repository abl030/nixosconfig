# Proxmox template evaluation warnings

This documents the two evaluation warnings seen during `nix flake check` for
`packages.x86_64-linux.proxmox-template`, the local fix, and the upstream issue.

## Repro (before local fix)

Command:

```sh
nix eval .#packages.x86_64-linux.proxmox-template --show-trace
```

Warnings:

```
evaluation warning: 'system' has been renamed to/replaced by 'stdenv.hostPlatform.system'
evaluation warning: Obsolete option `proxmox.qemuConf.diskSize' is used. It was renamed to `virtualisation.diskSize'.
```

## Warning 1: deprecated `pkgs.system` (fixed locally)

Source:
- `nix/devshell.nix` passed `inherit (pkgs) system;` into `nixosGenerate`.

Reason:
- `pkgs.system` is a deprecated alias; nixpkgs now prefers
  `pkgs.stdenv.hostPlatform.system`.

Fix (done):
- Pass the flake `system` argument directly.
- Change: `nix/devshell.nix` now uses `inherit system;`.

Result:
- The `system` deprecation warning is gone for the proxmox template eval.

## Warning 2: `proxmox.qemuConf.diskSize` rename (upstream)

Source:
- `nixpkgs` module: `nixos/modules/virtualisation/proxmox-image.nix`
  imports a rename module:

```nix
(lib.mkRenamedOptionModuleWith {
  sinceRelease = 2411;
  from = [ "proxmox" "qemuConf" "diskSize" ];
  to = [ "virtualisation" "diskSize" ];
})
```

Why it still warns:
- The module later renders `config.proxmox.qemuConf` into `qemu-server.conf`.
- `config.proxmox.qemuConf` includes the renamed `diskSize` option, so accessing
  it triggers the rename warning even when users never set the old option.

This warning cannot be removed from this repo without patching nixpkgs.
Decision: accept the warning until upstream is fixed.

## Draft PR (upstream, very tight)

Target repo:
- `https://github.com/NixOS/nixpkgs`

Target file:
- `nixos/modules/virtualisation/proxmox-image.nix`

Intent:
- Do not include the renamed `diskSize` in the generated `qemu-server.conf`,
  so evaluating the module does not trigger the rename warning.

Minimal diff idea:
- Filter `diskSize` out of `cfg.qemuConf` before it is passed to `cfgFile`.

Example patch:

```nix
      cfgFile =
        fileName: properties:
        let
          filtered = lib.removeAttrs properties [ "diskSize" ];
        in
        pkgs.writeTextDir fileName ''
          # generated by NixOS
          ${lib.concatStrings (lib.mapAttrsToList cfgLine filtered)}
          #qmdump#map:virtio0:drive-virtio0:${virtio0Storage}:raw:
        '';
```

PR title (tight):
- `proxmox-image: drop diskSize from qemu-server.conf`

PR body (tight):
- `Avoids triggering the proxmox.qemuConf.diskSize rename warning during eval.`
- `No behavior change; disk size is not a qemu-server.conf property.`

Steps to open the PR:
1. Fork `https://github.com/NixOS/nixpkgs`.
2. Create branch: `fix-proxmox-diskSize-warning`.
3. Apply the change in `nixos/modules/virtualisation/proxmox-image.nix`.
4. Run a basic check (keep it minimal):
   - `nix flake check` (or at least `nix eval .#nixosModules`).
5. Push branch and open PR against `NixOS/nixpkgs`.
