# Podman Current State

Last updated: 2026-02-15

## Scope

This document records current, observed behavior for container stacks managed by `stacks/lib/podman-compose.nix`.

## Runtime Model

1. Stack lifecycle owner is the user unit `${stackName}.service`.
2. Deploy path is `podman compose up -d --remove-orphans` (no deploy-time `--wait`).
3. Startup timeout is bounded (`startupTimeoutSeconds`, default 120 seconds).
4. Env files are sourced from system-scope `sops.secrets` paths; legacy fallback support exists for one release.
5. Scheduled stack updates use compose pull/redeploy units:
   - `podman-auto-update.service` now orchestrates per-stack `*-update.service` units.
   - Each stack update unit runs `podman compose pull` followed by `podman compose up -d --remove-orphans`.
   - Global update service continues-on-error across stacks, then fails with an aggregated summary if any stack update failed.
   - Compose provider is pinned via `PODMAN_COMPOSE_PROVIDER` to a wrapper that executes `docker compose`.
6. Unit files for stack services are generated by Home Manager into `~/.config/systemd/user/...`.

## Rebuild and Change Propagation

1. Compose and env file changes are represented as new Nix store paths and updated unit references.
2. Rebuild does not use compose health gating (`--wait`), so activation is not blocked on runtime health convergence.
3. A documented `igpu` test showed that stale user-level unit artifacts in `~/.config/systemd/user` can cause restarts to continue using old unit definitions even when `/etc/systemd/user` is updated.
4. In that test, removing stale user-level unit artifacts switched `FragmentPath` to `/etc/systemd/user/...` and the updated compose command was then observed.
5. This is now treated as an ownership-collision risk between unit sources, not a compose-wrapper bug.

Evidence: `docs/podman/incidents/2026-02-13-compose-change-propagation-test.md`

## Phase 2.5 Direction (Accepted, Completed)

1. Keep stack lifecycle in user scope (`${stackName}.service` remains user service).
2. Unit ownership is migrated from NixOS `/etc/systemd/user` generation to Home Manager `~/.config/systemd/user` generation.
3. Single ownership per unit name is enforced operationally (no dual `/etc` and `~/.config` resolution accepted).
4. Post-switch ownership checks use `FragmentPath` and `DropInPaths` as operational invariants.
5. Treat "user manager unavailable" as a reconciliation failure condition that must be surfaced explicitly.

Implementation plan: `docs/podman/current/phase2.5-home-manager-migration-plan.md`

## Implementation and Validation Status

1. Stack unit ownership migration is implemented in the shared stack library (`stacks/lib/podman-compose.nix`).
2. Ownership assertions now run in Home Manager activation after `reloadSystemd`.
3. Non-prod local e2e validation completed on `wsl` using two dummy stacks (`restart-probe`, `restart-probe-b`), including mutation propagation.
4. `igpu` and `proxmox-vm` (`doc1`) rebuild/deploy validation completed and operator-verified.

Evidence:
- `docs/podman/incidents/2026-02-14-wsl-phase2.5-e2e-validation.md`
- `docs/podman/current/phase2.5-home-manager-migration-plan.md`
- `docs/podman/incidents/2026-02-15-doc1-igpu-rollout-validation.md`

## Update Mechanism Direction (Current)

1. Podman compat-path auto-update (`podman auto-update`) is no longer used as the compose stack updater due to empty `RawImageName` failures.
2. Rootless compose updates are now done through per-stack update units and a scheduled orchestrator.
3. Provenance checks/timers from Phase 2.6 remain active.
4. Rollout outcome reported by operator after rebuilds on `doc1` and `igpu`: updates worked as expected.

Evidence:
- `docs/podman/research/2026-02-15-podman-autoupdate-compose-raw-image-report.md`
- `docs/podman/incidents/2026-02-14-wsl-phase2.6-validation.md`

## Accepted Residual Risks

1. Restart exit-code ambiguity for oneshot stacks is accepted for now because runtime health monitoring (for example Uptime Kuma and container health/state checks) is treated as the source of truth.
2. Systemd/user-unit activation is intentionally not used as app-readiness gating; runtime health is monitored at the application layer.
3. No-op drift auto-heal gap is accepted for now because the normal flake workflow runs Home Manager activation during rebuild/switch, which limits practical exposure.
4. `/etc/systemd/user` drop-in tampering risk is accepted for now as a low-likelihood/manual-vandalism class event in this homelab context.
5. Compose-managed stacks do not rely on Podman metadata-dependent `podman auto-update`; update safety is now tied to compose pull/redeploy behavior and app-level monitoring.

## Related Records

- Decision record: `docs/podman/decisions/2026-02-12-container-lifecycle-strategy.md`
- Ownership decision update: `docs/podman/decisions/2026-02-13-home-manager-user-unit-ownership.md`
- Research summary: `docs/podman/research/container-lifecycle-analysis-2026-02.md`
- Ownership migration research: `docs/podman/research/home-manager-user-service-migration-research-2026-02.md`
- Auto-update compat-path research: `docs/podman/research/2026-02-15-podman-autoupdate-compose-raw-image-report.md`
- Historical implementation plan: `docs/podman/archive/plans/2026-02-13-phase2-execution-plan.md`
