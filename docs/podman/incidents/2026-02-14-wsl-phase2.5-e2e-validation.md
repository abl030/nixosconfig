# WSL Phase 2.5 E2E Validation

Date: 2026-02-14  
Host: `wsl` (non-prod)  
Scope: Phase 2.5 ownership migration runtime validation

## Setup

1. Enabled `homelab.containers.enable` on `wsl`.
2. Added dummy stacks to `wsl` host config:
   - `restart-probe`
   - `restart-probe-b`

## Result

1. `nixos-rebuild switch --flake .#wsl` succeeded with both stack units active.
2. Ownership path checks passed from running system:
   - `FragmentPath=/home/nixos/.config/systemd/user/restart-probe-stack.service`
   - `FragmentPath=/home/nixos/.config/systemd/user/restart-probe-b-stack.service`
   - `DropInPaths=` (empty for both)
3. Containers started and labeled with correct user service ownership:
   - `PODMAN_SYSTEMD_UNIT=restart-probe-stack.service`
   - `PODMAN_SYSTEMD_UNIT=restart-probe-b-stack.service`

## Mutation Test

1. Changed `restart-probe-b` env from `PROBE_VERSION=v2` to `PROBE_VERSION=v3`.
2. Re-ran `nixos-rebuild switch --flake .#wsl`.
3. Runtime output confirmed propagation:
   - `podman logs restart-probe-b-restart-probe-b-1` included `restart-probe-b v3`.

## Additional Scenario Coverage

1. S01/S02 (shadowing + daemon-reload behavior):
   - Injected lower-precedence unit at `/run/systemd/user/restart-probe-stack.service`.
   - After `systemctl --user daemon-reload` + restart, active `FragmentPath` remained under `~/.config/systemd/user`.
2. S08 (auto-update interaction):
   - Real `podman-auto-update.service` run on WSL exposed a failure-accounting bug in wrapper script (`! cmd` status inversion).
   - Wrapper fixed to preserve true exit code and fail on dry-run command failure.
   - Re-test: `systemctl restart podman-auto-update.service` now exits non-zero and service enters failed state when Podman reports `raw-image name is empty`.
3. S12 (rollback reconciliation):
   - `switch-to-configuration --rollback` then forward `nixos-rebuild switch --flake .#wsl` both kept stack unit active and owned by Home Manager path.

## Notes

1. Initial ownership assertion placement in NixOS activation ran too early (before HM user-unit reload) and failed.
2. Final implementation moved ownership assertions to Home Manager activation after `reloadSystemd`, which resolved ordering.
3. S05 (secret/env missing), S11 (user manager unavailable/degraded in production-like state), and full host rollout validation on `igpu` and `proxmox-vm` (`doc1`) remain pending.
