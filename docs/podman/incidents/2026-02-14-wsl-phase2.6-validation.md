# WSL Phase 2.6 Local Validation

Date: 2026-02-14  
Host: `wsl`  
Scope: Local implementation and validation for Phase 2.6 reliability hardening

## Code Implemented

1. Verified apply transaction moved into `ExecStart` (`apply-and-verify` wrapper) in `stacks/lib/podman-compose.nix`.
2. Stack service default changed to `Restart=no` in `stacks/lib/podman-compose.nix`.
3. Home Manager stack-unit ownership hardening kept in place:
   - per-unit `xdg.configFile.<...>.force = true`,
   - activation ownership assertions (`FragmentPath`, `DropInPaths`).
4. Provenance reconciliation added in `modules/nixos/homelab/containers/default.nix`:
   - `systemd.user.startServices = "sd-switch"`,
   - `podman-provenance-audit.service` + `.timer`,
   - `NeedDaemonReload` auto-reload path.

## Test Outcomes

1. T01 no-op rebuild idempotency: PASS
   - `StartedAt` timestamps for both probe containers were unchanged across a no-op `nixos-rebuild switch`.
2. T02 verified restart success path: PASS
   - `systemctl --user restart restart-probe-stack.service` and `restart-probe-b-stack.service` returned `0`.
   - Units ended `ActiveState=active`, `SubState=exited`, `Result=success`.
3. T03 verified restart failure path (forced unhealthy): PARTIAL
   - Forced failing healthcheck reproduced verification failure (`ExecMainStatus=1` with verify timeout logs).
   - `systemctl --user restart ...` still returned `0` and unit `Result` did not consistently surface failed state in this oneshot pattern.
   - This remains a known semantics gap for strict "restart exit code is authoritative" guarantees.
4. T05 drift auto-heal on no-op rebuild: FAIL (known limitation)
   - Replacing `~/.config/systemd/user/restart-probe-stack.service` with a regular file persisted across no-op `nixos-rebuild switch`.
   - Recovery required a Home Manager activation run (`systemctl restart home-manager-nixos.service`) to restore the managed symlink.
5. T06 stale `/etc` drop-in detection path: BLOCKED IN WSL
   - WSL host had `/etc/systemd/user` mounted read-only during this run, so `/etc` drop-in injection could not be performed.
6. T07 `NeedDaemonReload` provenance handling: PASS
   - User drop-in mutation set `NeedDaemonReload=yes`.
   - Running `podman-provenance-audit.service` cleared it back to `no`.
7. Auto-update wrapper failure propagation (non-prod): PASS
   - Manual `podman-auto-update.service` run failed with non-zero exit (`status=125`) when Podman reported update errors.
   - Wrapper preserved Podman error and service result was failed, as intended.

## Observed Residual Risks

1. Oneshot restart failure semantics are still not fully authoritative via `systemctl restart` exit code for all failure shapes.
2. Drift auto-heal does not self-repair on pure no-op rebuild paths without an HM activation pass.
3. WSL filesystem constraints can block `/etc/systemd/user` provenance simulations.

## Evidence Commands Used

1. `systemctl --user show <unit> -p FragmentPath -p DropInPaths -p NeedDaemonReload -p ActiveState -p Result -p ExecMainStatus`
2. `journalctl --user -u <unit> --no-pager`
3. `sudo nixos-rebuild switch --flake .#wsl`
4. `podman inspect ... StartedAt`
5. `sudo systemctl start podman-auto-update.service`
