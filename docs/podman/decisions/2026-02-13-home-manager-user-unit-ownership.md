# Decision: Home Manager Ownership for Stack User Units

**Date:** 2026-02-13  
**Status:** Accepted (implementation in code complete; rollout pending)  
**Scope:** Stack lifecycle user units (`${stackName}.service`)  
**Primary research:** [home-manager-user-service-migration-research-2026-02.md](../research/home-manager-user-service-migration-research-2026-02.md)  
**Related incident:** [2026-02-13-compose-change-propagation-test.md](../incidents/2026-02-13-compose-change-propagation-test.md)

## Context

`igpu` propagation testing showed a reproducible failure class where stale unit files under `~/.config/systemd/user` override updated stack units generated by NixOS under `/etc/systemd/user`.

This is consistent with user unit search path precedence and explains why `systemctl --user daemon-reload && systemctl --user restart <unit>` can continue executing stale definitions when a higher-precedence unit file remains present.

## Decision

1. Keep stack lifecycle in user scope (no move to system service ownership).
2. Migrate stack unit ownership from NixOS `/etc/systemd/user` generation to Home Manager `systemd.user.services` generation.
3. Enforce single ownership for each stack unit name (no simultaneous definitions across `/etc/systemd/user` and `~/.config/systemd/user`).
4. Add post-switch ownership assertions using:
   - `systemctl --user show <unit> -p FragmentPath -p DropInPaths`
5. Treat "user manager unavailable/unreachable" as a reconciliation failure signal that must be surfaced explicitly.

## Rationale

1. This migration materially mitigates the exact ownership-collision failure observed in production-style testing.
2. It keeps lifecycle control in user scope, preserving current Podman auto-update model and labeling invariants.
3. It does not assume Home Manager is a universal cure; user-manager availability and drop-in drift remain explicit residual risks and are included in Phase 2.5 test gates.

## Consequences

### Positive

1. Eliminates the most likely `/etc` vs `~/.config` shadowing collision for stack unit definitions.
2. Clarifies stack-unit source of truth.
3. Aligns unit ownership with user-scoped control plane behavior.

### Residual Risks

1. Home Manager skips service switching if user systemd manager is not running/reachable.
2. User-level drop-ins and transient/control paths can still alter effective unit behavior.
3. Migration must include cleanup of old ownership artifacts to avoid transitional conflicts.

## Implementation Link

- Active implementation plan: `docs/podman/current/phase2.5-home-manager-migration-plan.md`
