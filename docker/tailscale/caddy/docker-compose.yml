version: "3.7"

services:
  network-holder:
    image: k8s.gcr.io/pause:3.9
    container_name: caddy_network_holder
    hostname: caddy
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"

  tailscale:
    image: tailscale/tailscale:latest
    container_name: ts-caddy
    network_mode: service:network-holder
    environment:
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_HOSTNAME=caddy
    volumes:
      - /mnt/docker/tailscale/ts-state:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - net_admin
      - sys_module
    restart: unless-stopped
    healthcheck:
      test: tailscale status --peers=false --json | grep -q 'Online.*true'
      start_period: 60s
    depends_on:
      - network-holder

  caddy:
    image: ghcr.io/caddybuilds/caddy-cloudflare:latest
    container_name: caddy-reverse-proxy
    network_mode: service:network-holder
    environment:
      - CLOUDFLARE_API_TOKEN=${CLOUDFLARE_API_TOKEN}
    volumes:
      # ─── UPDATED VOLUME ───
      # Use the path provided by Nix via the environment variable
      - ${CADDY_FILE}:/etc/caddy/Caddyfile
      # ──────────────────────
      - /mnt/docker/tailscale/caddy_data:/data
      - /mnt/docker/tailscale/caddy_config:/config
    restart: always
    depends_on:
      tailscale:
        condition: service_healthy
      network-holder:
        condition: service_started
