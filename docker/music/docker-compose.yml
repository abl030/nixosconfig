version: "3.8"

services:
  # ---------------------------------------------------------------
  # Network Holder
  # ---------------------------------------------------------------
  music-network-holder:
    image: k8s.gcr.io/pause:3.9
    container_name: music_network_holder
    ports:
      - "8686:8686" # Lidarr
      - "3579:3579" # Ombi internal port
    restart: unless-stopped
    # FIX 1: Explicit DNS often resolves routing weirdness in nested stacks
    dns:
      - 1.1.1.1
      - 8.8.8.8
    networks:
      - music-net

  # ---------------------------------------------------------------
  # Lidarr
  # ---------------------------------------------------------------
  lidarr:
    image: lscr.io/linuxserver/lidarr:latest
    container_name: lidarr
    environment:
      - PUID=99
      - PGID=100
      - TZ=Australia/Perth
    volumes:
      - /mnt/docker/music/lidarr:/config
      - /mnt/data/Media/Temp:/downloads
      - /mnt/fuse/Media/Music_RW:/music
    network_mode: "service:music-network-holder"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8686/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - autoheal=true
    depends_on:
      - music-network-holder

  # ---------------------------------------------------------------
  # Ombi
  # ---------------------------------------------------------------
  ombi:
    image: lscr.io/linuxserver/ombi:latest
    container_name: ombi
    environment:
      - PUID=99
      - PGID=100
      - TZ=Australia/Perth
    volumes:
      - /mnt/docker/ombi/config:/config
    network_mode: "service:music-network-holder"
    restart: unless-stopped
    depends_on:
      # FIX 2: Wait for DB to be actually ready, not just started
      ombi-db:
        condition: service_healthy
      music-network-holder:
        condition: service_started

  ombi-db:
    image: mariadb:10.11
    container_name: ombi-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${OMBI_DB_ROOT_PASSWORD}
      MYSQL_USER: ${OMBI_DB_USER}
      MYSQL_PASSWORD: ${OMBI_DB_PASSWORD}
    volumes:
      - /mnt/docker/ombi/db:/var/lib/mysql
      - ${INIT_SQL}:/docker-entrypoint-initdb.d/init.sql:ro
    network_mode: "service:music-network-holder"
    # FIX 3: Healthcheck ensures DB is ready before Ombi starts
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      - music-network-holder

  # ---------------------------------------------------------------
  # Tailscale Sidecar
  # ---------------------------------------------------------------
  tailscale:
    image: tailscale/tailscale:latest
    container_name: music-tailscale-sidecar
    network_mode: "service:music-network-holder"
    volumes:
      - /mnt/docker/tailscale/music:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun
      - /etc/localtime:/etc/localtime:ro
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      - TS_HOSTNAME=music
      - TS_STATE_DIR=/var/lib/tailscale
      # FIX 4: Use Userspace mode.
      # This prevents Tailscale from hijacking the kernel routing table,
      # allowing Ombi to reach the internet (MusicBrainz) via the Docker bridge.
      - TS_USERSPACE=true
      - TS_ACCEPT_DNS=false
    restart: unless-stopped
    depends_on:
      - music-network-holder

  # ---------------------------------------------------------------
  # Caddy Reverse Proxy
  # ---------------------------------------------------------------
  caddy:
    image: ghcr.io/caddybuilds/caddy-cloudflare:latest
    container_name: music-caddy
    network_mode: "service:music-network-holder"
    environment:
      - CLOUDFLARE_API_TOKEN=${CLOUDFLARE_DNS_API_TOKEN}
    volumes:
      - ${CADDY_FILE}:/etc/caddy/Caddyfile:ro
      - /mnt/docker/music/caddy/data:/data
      - /mnt/docker/music/caddy/config:/config
      - /etc/localtime:/etc/localtime:ro
    restart: unless-stopped
    depends_on:
      - music-network-holder

networks:
  music-net:
    driver: bridge
