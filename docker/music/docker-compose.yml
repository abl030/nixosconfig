version: "3.8"

services:
  # ---------------------------------------------------------------
  # Network Holder
  # ---------------------------------------------------------------
  music-network-holder:
    image: k8s.gcr.io/pause:3.9
    labels:
      - io.containers.autoupdate=registry
    container_name: music_network_holder
    ports:
      - "8686:8686" # Lidarr
      - "3579:3579" # Ombi internal port
      - "8085:8085" # Filebrowser
    restart: unless-stopped
    dns:
      - 1.1.1.1
      - 8.8.8.8
    networks:
      - music-net

  # ---------------------------------------------------------------
  # Lidarr
  # ---------------------------------------------------------------
  lidarr:
    image: lscr.io/linuxserver/lidarr:latest
    container_name: lidarr
    environment:
      - PUID=99
      - PGID=100
      - TZ=Australia/Perth
    volumes:
      - ${DATA_ROOT}/music/lidarr:/config
      - ${MEDIA_ROOT:-/mnt/data}/Media/Temp:/downloads
      - ${FUSE_ROOT:-/mnt/fuse}/Media/Music_RW/Ali/:/music
    network_mode: "service:music-network-holder"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8686/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - io.containers.autoupdate=registry
      - autoheal=true
    depends_on:
      - music-network-holder

  # ---------------------------------------------------------------
  # Ombi
  # ---------------------------------------------------------------
  ombi:
    image: lscr.io/linuxserver/ombi:latest
    labels:
      - io.containers.autoupdate=registry
    container_name: ombi
    environment:
      - PUID=99
      - PGID=100
      - TZ=Australia/Perth
    volumes:
      - ${DATA_ROOT}/ombi/config:/config
    network_mode: "service:music-network-holder"
    restart: unless-stopped
    depends_on:
      ombi-db:
        condition: service_healthy
      music-network-holder:
        condition: service_started

  ombi-db:
    image: docker.io/library/mariadb:10.11
    labels:
      - io.containers.autoupdate=registry
    container_name: ombi-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${OMBI_DB_ROOT_PASSWORD}
      MYSQL_USER: ${OMBI_DB_USER}
      MYSQL_PASSWORD: ${OMBI_DB_PASSWORD}
    volumes:
      - ${DATA_ROOT}/ombi/db:/var/lib/mysql
      - ${INIT_SQL}:/docker-entrypoint-initdb.d/init.sql:ro
    network_mode: "service:music-network-holder"
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      - music-network-holder

  # ---------------------------------------------------------------
  # Filebrowser
  # ---------------------------------------------------------------
  filebrowser:
    image: docker.io/filebrowser/filebrowser:v2
    labels:
      - io.containers.autoupdate=registry
    container_name: music-filebrowser
    # Run as user 99 (nobody) to match host permissions
    user: "99:100"
    network_mode: "service:music-network-holder"
    environment:
      - FB_DATABASE=/config/filebrowser.db
      - FB_ROOT=/srv
      - FB_LOG=stdout
      - FB_PORT=8085
      - FB_ADDRESS=0.0.0.0
    volumes:
      # Mount the folder created by Nix (owned by 99:100) to /config
      - ${DATA_ROOT}/music/filebrowser:/config
      # Mount music as Read-Only
      - ${FUSE_ROOT:-/mnt/fuse}/Media/Music_RW:/srv:ro
      # Fix for timezone if needed
      - /etc/localtime:/etc/localtime:ro
    restart: unless-stopped
    depends_on:
      - music-network-holder

  # ---------------------------------------------------------------
  # Tailscale Sidecar
  # ---------------------------------------------------------------
  tailscale:
    image: docker.io/tailscale/tailscale:latest
    labels:
      - io.containers.autoupdate=registry
    container_name: music-tailscale-sidecar
    network_mode: "service:music-network-holder"
    volumes:
      - ${DATA_ROOT}/tailscale/music:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun
      - /etc/localtime:/etc/localtime:ro
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      - TS_HOSTNAME=music
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=true
      - TS_ACCEPT_DNS=false
    restart: unless-stopped
    depends_on:
      - music-network-holder

  # ---------------------------------------------------------------
  # Caddy Reverse Proxy
  # ---------------------------------------------------------------
  caddy:
    image: ghcr.io/caddybuilds/caddy-cloudflare:latest
    labels:
      - io.containers.autoupdate=registry
    container_name: music-caddy
    network_mode: "service:music-network-holder"
    environment:
      - CLOUDFLARE_API_TOKEN=${CLOUDFLARE_DNS_API_TOKEN}
    volumes:
      - ${CADDY_FILE}:/etc/caddy/Caddyfile:ro
      - ${DATA_ROOT}/music/caddy/data:/data
      - ${DATA_ROOT}/music/caddy/config:/config
      - /etc/localtime:/etc/localtime:ro
    restart: unless-stopped
    depends_on:
      - music-network-holder

networks:
  music-net:
    driver: bridge
