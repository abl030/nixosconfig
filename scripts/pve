#!/usr/bin/env bash
# Enhanced Proxmox CLI Wrapper
# Wraps proxmox-ops.sh with ergonomic commands and jq-formatted output

set -euo pipefail

# Color output helpers
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

error() {
    echo -e "${RED}Error: $*${NC}" >&2
    exit 1
}

success() {
    echo -e "${GREEN}$*${NC}"
}

info() {
    echo -e "${BLUE}$*${NC}"
}

warning() {
    echo -e "${YELLOW}$*${NC}"
}

# Find proxmox-ops.sh
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROXMOX_OPS="${SCRIPT_DIR}/../vms/proxmox-ops.sh"

if [[ ! -x "$PROXMOX_OPS" ]]; then
    error "proxmox-ops.sh not found at $PROXMOX_OPS"
fi

# Usage information
usage() {
    cat <<EOF
pve - Enhanced Proxmox CLI Wrapper

USAGE:
    pve <command> [arguments]

VIEWING/LISTING:
    list, ls              List all VMs (table format)
    ps                    Show only running VMs
    status <vmid>         Get status of specific VM
    info <vmid>           Show detailed VM configuration
    config <vmid>         Show raw Proxmox config

NETWORK:
    ip <vmid>             Get IP address of VM
    ips                   List all running VMs with IPs

LIFECYCLE:
    start <vmid>          Start VM
    stop <vmid>           Stop VM (immediate)
    shutdown <vmid>       Shutdown VM (graceful)
    restart <vmid>        Restart VM
    destroy <vmid>        Destroy VM (requires confirmation)

PROVISIONING:
    new <name>            Provision new VM
    provision <name>      Alias for new
    integrate <name> <ip> <vmid>
                          Post-provision fleet integration
    next-vmid [start] [end]
                          Get next available VMID
    defs                  Show VM definitions

RESOURCE MANAGEMENT:
    resize-cpu <vmid> <cores>
                          Change CPU cores
    resize-ram <vmid> <mb>
                          Change RAM (in MB)
    resize-disk <vmid> <disk> <size>
                          Resize disk (e.g., scsi0 +10G)
    add-disk <vmid> <size> [storage] [disk]
                          Add new disk to VM

HOST/STORAGE:
    storage               Show storage status
    host                  Show Proxmox host info

UTILITY:
    wait <vmid>           Wait for VM to be SSH accessible
    help                  Show this help
    version               Show version

EXAMPLES:
    pve list              # List all VMs
    pve ps | jq           # Show running VMs as JSON
    pve ip 110            # Get IP of VMID 110
    pve start 110         # Start VMID 110
    pve new my-service    # Provision new VM
EOF
}

# Parse command
CMD="${1:-help}"
shift || true

case "$CMD" in
    # Viewing/Listing
    list|ls)
        info "Listing all VMs..."
        "$PROXMOX_OPS" list | jq -r '
            ["VMID", "NAME", "STATUS", "CPU", "RAM(GB)", "DISK"],
            ["----", "----", "------", "---", "-------", "----"],
            (.[] | select(.type=="qemu") | [
                .vmid,
                .name,
                .status,
                .maxcpu // "?",
                ((.maxmem // 0) / 1024 / 1024 / 1024 | floor),
                (.maxdisk // 0 | if . > 0 then (. / 1024 / 1024 / 1024 | floor | tostring + "G") else "?" end)
            ]) | @tsv
        ' | column -t
        ;;

    ps)
        info "Showing running VMs..."
        "$PROXMOX_OPS" list | jq -r '
            ["VMID", "NAME", "STATUS", "CPU", "RAM(GB)"],
            ["----", "----", "------", "---", "-------"],
            (.[] | select(.type=="qemu" and .status=="running") | [
                .vmid,
                .name,
                .status,
                .maxcpu // "?",
                ((.maxmem // 0) / 1024 / 1024 / 1024 | floor)
            ]) | @tsv
        ' | column -t
        ;;

    status)
        [[ -z "${1:-}" ]] && error "Usage: pve status <vmid>"
        "$PROXMOX_OPS" status "$1"
        ;;

    info)
        [[ -z "${1:-}" ]] && error "Usage: pve info <vmid>"
        info "VM Configuration for VMID $1:"
        "$PROXMOX_OPS" config "$1" | grep -E "^(cores|memory|net0|scsi0|ide2|sockets|cpu)" || true
        ;;

    config)
        [[ -z "${1:-}" ]] && error "Usage: pve config <vmid>"
        "$PROXMOX_OPS" config "$1"
        ;;

    # Network
    ip)
        [[ -z "${1:-}" ]] && error "Usage: pve ip <vmid>"
        "$PROXMOX_OPS" get-ip "$1"
        ;;

    ips)
        info "VM IP Addresses (running VMs only)..."
        "$PROXMOX_OPS" list | jq -r '.[] | select(.type=="qemu" and .status=="running") | .vmid' | while read -r vmid; do
            ip=$("$PROXMOX_OPS" get-ip "$vmid" 2>/dev/null || echo "unknown")
            name=$("$PROXMOX_OPS" config "$vmid" 2>/dev/null | grep "^name:" | cut -d' ' -f2 || echo "unknown")
            echo "$vmid	$name	$ip"
        done | column -t -N "VMID,NAME,IP"
        ;;

    # Lifecycle
    start)
        [[ -z "${1:-}" ]] && error "Usage: pve start <vmid>"
        info "Starting VM $1..."
        "$PROXMOX_OPS" start "$1"
        success "VM $1 started"
        ;;

    stop)
        [[ -z "${1:-}" ]] && error "Usage: pve stop <vmid>"
        warning "Stopping VM $1 (immediate)..."
        "$PROXMOX_OPS" stop "$1"
        success "VM $1 stopped"
        ;;

    shutdown)
        [[ -z "${1:-}" ]] && error "Usage: pve shutdown <vmid>"
        info "Shutting down VM $1 (graceful)..."
        "$PROXMOX_OPS" shutdown "$1"
        success "VM $1 shutdown initiated"
        ;;

    restart)
        [[ -z "${1:-}" ]] && error "Usage: pve restart <vmid>"
        info "Restarting VM $1..."
        "$PROXMOX_OPS" stop "$1"
        sleep 3
        "$PROXMOX_OPS" start "$1"
        success "VM $1 restarted"
        ;;

    destroy)
        [[ -z "${1:-}" ]] && error "Usage: pve destroy <vmid>"
        warning "WARNING: This will permanently destroy VM $1!"
        echo -n "Type 'yes' to confirm: "
        read -r confirm
        if [[ "$confirm" == "yes" ]]; then
            "$PROXMOX_OPS" destroy "$1" yes
            success "VM $1 destroyed"
        else
            info "Destroy cancelled"
            exit 1
        fi
        ;;

    # Provisioning
    new|provision)
        [[ -z "${1:-}" ]] && error "Usage: pve new <name>"
        info "Provisioning VM: $1"
        nix run .#provision-vm "$1"
        ;;

    integrate)
        [[ -z "${3:-}" ]] && error "Usage: pve integrate <name> <ip> <vmid>"
        info "Integrating VM $1 into fleet..."
        nix run .#post-provision-vm "$1" "$2" "$3"
        ;;

    next-vmid)
        "$PROXMOX_OPS" next-vmid "${1:-100}" "${2:-199}"
        ;;

    defs)
        info "VM Definitions:"
        nix eval .#vms --json 2>/dev/null | jq -r '
            "=== Managed VMs ===",
            (.managed | to_entries[] | "  \(.key): VMID \(.value.vmid) - \(.value.purpose // "no description")"),
            "",
            "=== Imported VMs (readonly) ===",
            (.imported | to_entries[] | "  \(.key): VMID \(.value.vmid) - \(.value.purpose // "no description")")
        '
        ;;

    # Resource Management
    resize-cpu)
        [[ -z "${2:-}" ]] && error "Usage: pve resize-cpu <vmid> <cores>"
        info "Resizing VM $1 to $2 cores..."
        "$PROXMOX_OPS" configure "$1" "$2" "" || error "Failed to resize CPU"
        success "VM $1 CPU resized to $2 cores"
        ;;

    resize-ram)
        [[ -z "${2:-}" ]] && error "Usage: pve resize-ram <vmid> <mb>"
        info "Resizing VM $1 to $2 MB RAM..."
        "$PROXMOX_OPS" configure "$1" "" "$2" || error "Failed to resize RAM"
        success "VM $1 RAM resized to $2 MB"
        ;;

    resize-disk)
        [[ -z "${3:-}" ]] && error "Usage: pve resize-disk <vmid> <disk> <size>"
        info "Resizing disk $2 on VM $1 to $3..."
        "$PROXMOX_OPS" resize "$1" "$2" "$3" || error "Failed to resize disk"
        success "Disk $2 on VM $1 resized to $3"
        ;;

    add-disk)
        [[ -z "${2:-}" ]] && error "Usage: pve add-disk <vmid> <size> [storage] [disk]"
        info "Adding disk to VM $1..."
        "$PROXMOX_OPS" create-disk "$1" "$2" "${3:-}" "${4:-}" || error "Failed to add disk"
        success "Disk added to VM $1"
        ;;

    # Host/Storage
    storage)
        info "Proxmox Storage Status:"
        "$PROXMOX_OPS" storage
        ;;

    host)
        info "Proxmox Host Information:"
        # Get basic host info via SSH
        ssh root@192.168.1.12 'echo "Hostname: $(hostname)"; echo "Uptime: $(uptime -p)"; echo "Load: $(cat /proc/loadavg | cut -d" " -f1-3)"'
        ;;

    # Utility
    wait)
        [[ -z "${1:-}" ]] && error "Usage: pve wait <vmid>"
        ip=$("$PROXMOX_OPS" get-ip "$1" 2>/dev/null || error "Could not get IP for VM $1")
        info "Waiting for VM $1 ($ip) to be SSH accessible..."
        "$PROXMOX_OPS" wait-ssh "$ip" 300 abl030
        success "VM $1 is now accessible"
        ;;

    version)
        echo "pve CLI wrapper v1.0.0"
        "$PROXMOX_OPS" --version 2>/dev/null || echo "proxmox-ops.sh (bundled)"
        ;;

    help|-h|--help)
        usage
        ;;

    *)
        error "Unknown command: $CMD\n\nRun 'pve help' for usage"
        ;;
esac
