name: "Rolling Flake Update (PR CI)"

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write
  actions: read

# Cancel older runs when a new push lands to the same PR branch
concurrency:
  group: pr-populate-cache-${{ github.repository }}-${{ github.event.pull_request.head.ref }}
  cancel-in-progress: true

jobs:
  build-and-cache:
    runs-on: self-hosted
    name: Populate Cache # ← keep the displayed job name stable for branch protection / auto-merge

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}

      - name: Configure Cachix
        uses: cachix/cachix-action@v15
        with:
          name: nixosconfig
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      # Run flake checks instead of building/pushing cachix
      - name: Flake check (capture logs)
        id: flakecheck
        shell: bash
        env:
          # Keep NIX_CONFIG to benefit from substituters for dependencies during checks.
          NIX_CONFIG: |
            experimental-features = nix-command flakes
            substituters = https://nixcache.ablz.au?priority=10 https://nix-mirror.ablz.au?priority=20 https://nixosconfig.cachix.org?priority=30 https://cache.nixos.org?priority=40
            trusted-public-keys = ablz.au-1:EYnQ/c34qSA7oVBHC1i+WYh4IEkFSbLQdic+vhP4k54= nixosconfig.cachix.org-1:whoVlEsbDSqKiGUejiPzv2Vha7IcWIZWXue0grLsl2k= cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=
        run: |
          set -euo pipefail
          mkdir -p ci-logs
          LOG=ci-logs/flake-check.log

          set +e
          nix flake check --print-build-logs --keep-going 2>&1 | tee "$LOG"
          STATUS=${PIPESTATUS[0]}
          set -e

          echo "status=$STATUS" >> "$GITHUB_OUTPUT"

          # Helpers for PR comment
          tail -n 120 "$LOG" > ci-logs/tail.log || true
          nix shell nixpkgs#gawk --command awk '
            /error:/ {show=1; n=0}
            show {print; if (n++ > 80) exit}
          ' "$LOG" > ci-logs/first-error-snippet.log || true

          exit "$STATUS"

      - name: Upload logs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: flake-check-logs
          path: ci-logs/

      # Update/replace a single status comment. Keep the same HTML marker.
      - name: Update single PR status comment (always)
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          PR_NUMBER="${{ github.event.pull_request.number }}"
          MARKER="<!-- bot:rolling-status -->"
          status="${{ steps.flakecheck.outputs.status }}"

          if [ "$status" = "0" ]; then
            SUMMARY="✅ Flake check passed."
            DETAILS="All flake checks succeeded."
          else
            SUMMARY="❌ Flake check failed."
            SNIP=$( (echo '```'; cat ci-logs/first-error-snippet.log 2>/dev/null || true; echo '```') )
            TAIL=$( (echo '<details><summary>Log tail</summary>'; echo; echo '```'; cat ci-logs/tail.log 2>/dev/null || true; echo '```'; echo '</details>') )
            DETAILS="First error snippet:\n${SNIP}\n\n${TAIL}\n\nArtifacts: download \"flake-check-logs\" from this run."
          fi

          NEW_BODY="${MARKER}
          ${SUMMARY}
          ${DETAILS}
          ${MARKER}
          "

          # Find existing comment by marker
          CMT_ID="$(
            nix shell nixpkgs#gh --command gh api \
              "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
              --jq '.[] | select(.body | contains("'"$MARKER"'")) | .id' \
              | head -n1 || true
          )"

          if [ -n "$CMT_ID" ]; then
            nix shell nixpkgs#gh --command gh api \
              "repos/${{ github.repository }}/issues/comments/${CMT_ID}" \
              -X PATCH -f body="$NEW_BODY" >/dev/null
          else
            nix shell nixpkgs#gh --command gh pr comment "$PR_NUMBER" --body "$NEW_BODY" >/dev/null
          fi
