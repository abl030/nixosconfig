# VM Automation (OpenTofu + Proxmox)

This directory contains the OpenTofu/Terranix VM automation stack for the
Proxmox fleet. The single source of truth for VM specs lives in `hosts.nix`
under each host's `proxmox` attribute and the `_proxmox` top-level config.

## State Management

OpenTofu state is stored locally in `vms/tofu/.state` (not committed). If the
state is missing, OpenTofu will assume nothing exists and plan to recreate
resources. Keep the state directory intact or migrate it to a shared backend.

## Primary Workflows (via `pve`)

### Create a new VM

1. `pve new`
2. Review the OpenTofu plan when prompted.
3. Confirm apply to create the VM.
4. Run `pve integrate <name> <ip> <vmid>` to finalize NixOS config + secrets.

`pve new` copies base config files from `hosts/vm_base/` into `hosts/<name>/`
(`configuration.nix` and `home.nix`). The `hardware-configuration.nix` file is
generated during `pve integrate` by running `nixos-generate-config` over SSH
and saving the output into `hosts/<name>/`.

### Integrate a VM into the fleet

`pve integrate <name> <ip> <vmid>`

This runs post-provisioning: generates hardware config if missing, applies
NixOS, enrolls the VM in Tailscale using the stored credentials, updates
`hosts.nix`, updates `.sops.yaml`, and re-encrypts secrets. After the rebuild,
SSH from the machine that ran `pve integrate` should work without extra steps.

### Remove a VM

`pve remove <name>`

Removes host config and sops keys, updates secrets, then runs OpenTofu plan and
apply to destroy the VM resource.

## OpenTofu Commands

All OpenTofu apps are exposed via `pve`:

- `pve plan`   -> `nix run .#tofu-plan`
- `pve apply`  -> `nix run .#tofu-apply`
- `pve output` -> `nix run .#tofu-output`

## Supporting Files

- `vms/tofu/`: Terranix modules and OpenTofu configuration generation
- `vms/proxmox-ops.sh`: Proxmox SSH wrapper used by `pve`
- `vms/post-provision.sh`: Fleet integration steps
- `vms/package.nix`: Nix packaging that exposes the VM scripts as `nix run .#...` apps.

## `pve` vs `proxmox-ops`

`pve` is the high-level CLI. It wraps:
- OpenTofu apps (`nix run .#tofu-plan`, `nix run .#tofu-apply`, etc.)
- Post-provision workflow (`nix run .#post-provision-vm`)
- Direct Proxmox operations by calling `proxmox-ops`

`proxmox-ops` is the low-level SSH wrapper around Proxmox `qm`/`pvesh` commands.
Use `proxmox-ops` for direct VM operations; use `pve` for end-to-end workflows.

## Creating Custom VMs Manually

If you need a custom configuration (not using `pve new`), follow this pattern:

### Required: Match the vm_base Template

Your `hosts/<name>/configuration.nix` **must** be compatible with template 9003:

```nix
{pkgs, ...}: {
  imports = [
    ./hardware-configuration.nix  # Generated by pve integrate
  ];

  # IMPORTANT: Use GRUB, not systemd-boot (matches template 9003)
  boot.loader = {
    systemd-boot.enable = false;
    efi.canTouchEfiVariables = false;
    grub = {
      enable = true;
      devices = ["nodev"];
    };
  };

  # ... your custom config
}
```

### Common Mistakes to Avoid

1. **Don't override bios/diskInterface** - Template 9003 uses SeaBIOS and
   virtio0. If you set `bios = "ovmf"` or `diskInterface = "scsi0"`, the
   cloned VM won't boot because the disk layout won't match the BIOS
   expectations. Let these default:
   ```nix
   proxmox = {
     vmid = 111;
     cores = 4;
     memory = 8192;
     disk = "64G";
     # DON'T set: bios, machine, diskInterface - use defaults
   };
   ```

2. **Don't use disko** - Template 9003 has its own disk layout. The
   `hardware-configuration.nix` is generated from the running VM during
   `pve integrate`.

3. **Don't use systemd-boot** - Template 9003 uses GRUB. Using systemd-boot
   will fail because the EFI partition layout doesn't match.

4. **Don't skip `pve integrate`** - Even if you manually create hosts.nix
   and config files, you still need `pve integrate` to:
   - Generate hardware-configuration.nix from the actual VM
   - Deploy your NixOS config via nixos-rebuild
   - Enroll in Tailscale
   - Extract SSH host key and update secrets

### Workflow for Custom VMs

1. Add entry to `hosts.nix` with `proxmox = { vmid = ...; ... }`
2. Create `hosts/<name>/configuration.nix` (following vm_base pattern)
3. Create `hosts/<name>/home.nix`
4. Run `pve apply` to create VM from template 9003
5. Run `pve integrate <name> <ip> <vmid>` to deploy and integrate

### Example: Sandbox VM

See `hosts/sandbox/` for an example of a custom VM with:
- Isolation firewall (blocks local network)
- No fleet identity key (`deployIdentity = false`)
- Custom package set
